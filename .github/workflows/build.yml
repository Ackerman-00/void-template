name: Build Custom XBPS
on:
  workflow_dispatch:
    inputs:
      package_name:
        description: 'Which package to build?'
        required: true
        default: 'niri'
        type: choice
        options:
          - niri
          - vesktop
          - zen-browser
          - gpu-screen-recorder

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your template
        uses: actions/checkout@v4
        with:
          path: custom-repo

      - name: Build in Void Container
        run: |
          # 1. Make current directory accessible to the container
          chmod 777 .
          
          # 2. Run the build with --privileged (needed for chroot)
          docker run --privileged --rm -v ${PWD}:/home/work voidlinux/voidlinux /bin/sh -c "
            # --- ROOT TASKS (Setup) ---
            # Set the fast mirror
            mkdir -p /etc/xbps.d
            echo 'repository=https://repo-fastly.voidlinux.org/current' > /etc/xbps.d/00-repository-main.conf
            
            # Update and Install Dependencies
            xbps-install -Syu xbps &&
            xbps-install -Sy ca-certificates git base-devel xtools bash &&
            
            # Create the 'builder' user (xbps-src cannot run as root)
            useradd -m builder
            
            # Clone official packages to a folder we can access
            git clone --depth=1 https://github.com/void-linux/void-packages.git /home/builder/void-packages
            
            # Inject your custom template
            cp -r /home/work/custom-repo/${{ inputs.package_name }} /home/builder/void-packages/srcpkgs/
            
            # Give the builder user ownership of the folder
            chown -R builder:builder /home/builder/void-packages
            
            # --- USER TASKS (Build) ---
            # Switch to builder to run the actual build
            su builder -c '
              cd /home/builder/void-packages
              ./xbps-src binary-bootstrap
              ./xbps-src pkg ${{ inputs.package_name }}
            '
            
            # --- ROOT TASKS (Cleanup) ---
            # Copy the result out to the mounted volume
            # We check both locations because x86_64 packages sometimes land in a subdir
            cp /home/builder/void-packages/hostdir/binpkgs/*.xbps /home/work/ 2>/dev/null || \
            cp /home/builder/void-packages/hostdir/binpkgs/*/*.xbps /home/work/
          "

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.package_name }}-binary
          path: "**/*.xbps"
