# Template file for 'HeroicGamesLauncher'
pkgname=HeroicGamesLauncher
version=2.18.1
revision=1
archs="x86_64"
short_desc="Open source launcher for GOG, Epic, and Amazon Games"
maintainer="Ackerman <https://github.com/Ackerman-00>"
license="GPL-3.0-or-later"
homepage="https://heroicgameslauncher.com"
distfiles="https://github.com/Heroic-Games-Launcher/HeroicGamesLauncher/releases/download/v${version}/Heroic-${version}-linux-amd64.deb"
checksum=4f696b7593107a90ed3ff947a4b1e0dbf1734ba41cbcb8f366559fe963c43fad

hostmakedepends="binutils tar xz"
depends="nss atk alsa-lib libcups libdrm libgbm libXcomposite libXdamage libXrandr libXScrnSaver"

# WHITELIST: Tell Void to allow these pre-compiled non-PIE binaries
_helper_path="opt/Heroic/resources/app.asar.unpacked/build/bin/x64/linux"
nopie_files="
 /opt/Heroic/heroic
 /opt/Heroic/chrome-sandbox
 /${_helper_path}/gogdl
 /${_helper_path}/legendary
 /${_helper_path}/nile
 /${_helper_path}/comet
 /${_helper_path}/vulkan-helper"

nostrip_files="${nopie_files}"

do_extract() {
    # Extract the .deb archive
    ar x ${XBPS_SRCDISTDIR}/${pkgname}-${version}/Heroic-${version}-linux-amd64.deb
    mkdir -p ${wrksrc}
    # Unpack the data payload into the work directory
    tar xf data.tar.xz -C ${wrksrc}
}

do_install() {
    vmkdir usr/share/applications
    vmkdir usr/share/icons
    vmkdir opt/Heroic
    vmkdir usr/bin

    # Copy files from the extracted work directory
    vcopy usr/share/applications/*.desktop usr/share/applications
    vcopy usr/share/icons/hicolor usr/share/icons
    vcopy opt/Heroic/* opt/Heroic

    # Symlink and fix permissions
    ln -sf /opt/Heroic/heroic ${DESTDIR}/usr/bin/heroic
    chmod 755 ${DESTDIR}/opt/Heroic/heroic
    
    # SUID sandbox (Required for some Electron versions)
    if [ -f ${DESTDIR}/opt/Heroic/chrome-sandbox ]; then
        chmod 4755 ${DESTDIR}/opt/Heroic/chrome-sandbox
    fi
}
